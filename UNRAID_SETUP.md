# PHM Unraid Setup Guide

Complete guide for deploying PHM on Unraid NAS in one command.

## üöÄ Quick Start (TL;DR)

```bash
cd /mnt/user/appdata
git clone https://github.com/martinbibb-cmd/PHM2.git phm
cd phm
bash scripts/setup-unraid.sh
```

Visit `http://YOUR-SERVER-IP:3000` and log in with the credentials shown.

---

## üìã What This Setup Includes

### Automated Features

- ‚úÖ **Secure Password Generation**: Auto-generates 32+ character passwords for database and JWT
- ‚úÖ **Database Initialization**: Automatically runs migrations and seeds demo data
- ‚úÖ **Health Monitoring**: All containers have health checks and auto-restart
- ‚úÖ **Data Persistence**: All data stored on Unraid array (`/mnt/user/appdata/phm/`)
- ‚úÖ **Network Isolation**: Containers communicate via isolated bridge network
- ‚úÖ **One-Step Updates**: Pull and re-run setup script to update

### Services Deployed

1. **PostgreSQL 17** - Database (port 5432)
2. **PHM API** - Backend API server (port 3001)
3. **PHM Web** - React frontend (port 3000)
4. **DB Init** - One-time setup container (auto-removes after completion)

---

## üìÅ Directory Structure

After installation, your Unraid appdata will contain:

```
/mnt/user/appdata/phm/
‚îú‚îÄ‚îÄ postgres/          # PostgreSQL database files
‚îú‚îÄ‚îÄ uploads/           # User-uploaded files (photos, docs)
‚îî‚îÄ‚îÄ init-flag/         # Flag to prevent re-initialization
```

---

## üîß Detailed Setup Steps

### Step 1: Access Unraid Terminal

SSH into your Unraid server or use the built-in terminal:

```bash
ssh root@your-unraid-server
```

### Step 2: Navigate to Appdata

```bash
cd /mnt/user/appdata
```

### Step 3: Clone Repository

```bash
git clone https://github.com/martinbibb-cmd/PHM2.git phm
cd phm
```

### Step 4: Run Setup Script

```bash
bash scripts/setup-unraid.sh
```

The script will:
1. Check prerequisites (Docker, Docker Compose, OpenSSL)
2. Create necessary directories
3. Generate secure `.env` file with random passwords
4. Display configuration summary
5. Build Docker images (first run takes ~5 minutes)
6. Start all containers
7. Initialize database with demo data
8. Display login credentials

### Step 5: Access Your Platform

Navigate to `http://YOUR-SERVER-IP:3000` in your browser.

---

## üîê Default Login Credentials

After setup completes, you'll see output like:

```
üîë Login Credentials:
   Email:    admin@phm.local
   Password: abc123xyz789
```

**‚ö†Ô∏è IMPORTANT**: Change the admin password immediately after first login!

---

## üéõÔ∏è Configuration

### Environment Variables

All configuration is in `.env` (auto-generated by setup script).

To customize, edit `.env` before running the setup script:

```bash
cp .env.unraid.example .env
nano .env  # Edit as needed
bash scripts/setup-unraid.sh
```

Key variables:
- `DB_PASSWORD` - Database password
- `JWT_SECRET` - Access token secret
- `JWT_REFRESH_SECRET` - Refresh token secret
- `INITIAL_ADMIN_EMAIL` - Admin email
- `INITIAL_ADMIN_PASSWORD` - Admin password
- `WEB_PORT` - Web interface port (default: 3000)
- `APPDATA_PATH` - Data storage path (default: /mnt/user/appdata/phm)

### Port Configuration

If you have port conflicts, change these in `.env`:

```bash
WEB_PORT=3000        # Frontend
API_PORT=3001        # API
DB_PORT=5432         # PostgreSQL
```

### Network Configuration

By default, `CORS_ORIGIN=*` allows all origins. For production:

```bash
CORS_ORIGIN=http://your-domain.com
```

---

## üìä Management Commands

### View Logs

```bash
# All services
docker-compose -f docker-compose.unraid.yml logs -f

# Specific service
docker-compose -f docker-compose.unraid.yml logs -f api
docker-compose -f docker-compose.unraid.yml logs -f web
docker-compose -f docker-compose.unraid.yml logs -f postgres
```

### Check Status

```bash
docker-compose -f docker-compose.unraid.yml ps
```

### Restart Services

```bash
# All services
docker-compose -f docker-compose.unraid.yml restart

# Specific service
docker-compose -f docker-compose.unraid.yml restart api
```

### Stop Services

```bash
docker-compose -f docker-compose.unraid.yml down
```

### Start Services

```bash
docker-compose -f docker-compose.unraid.yml up -d
```

### Rebuild Containers

```bash
docker-compose -f docker-compose.unraid.yml up -d --build
```

---

## üîÑ Updating PHM

To update to the latest version:

```bash
cd /mnt/user/appdata/phm
git pull
bash scripts/setup-unraid.sh
```

The script will:
1. Preserve your existing `.env` (asks for confirmation)
2. Stop old containers
3. Rebuild with new code
4. Restart services
5. Keep all data intact

---

## üíæ Backup Strategy

### What to Backup

1. **Database**: `/mnt/user/appdata/phm/postgres/`
2. **Uploads**: `/mnt/user/appdata/phm/uploads/`
3. **Config**: `/mnt/user/appdata/phm/.env`

### Automated Backup (Unraid CA Backup Plugin)

Add these paths to CA Backup:
```
/mnt/user/appdata/phm/postgres
/mnt/user/appdata/phm/uploads
/mnt/user/appdata/phm/.env
```

### Manual Backup

```bash
# Create backup
tar -czf phm-backup-$(date +%Y%m%d).tar.gz \
  -C /mnt/user/appdata/phm \
  postgres uploads .env

# Restore backup
cd /mnt/user/appdata/phm
tar -xzf phm-backup-YYYYMMDD.tar.gz
```

---

## üêõ Troubleshooting

### Containers Won't Start

Check logs:
```bash
docker-compose -f docker-compose.unraid.yml logs
```

Common issues:
- Port already in use: Change `WEB_PORT` in `.env`
- Database not ready: Wait 30 seconds, check `postgres` health
- Permission issues: Ensure `/mnt/user/appdata/phm` is writable

### Can't Access Web Interface

1. Check service is running:
   ```bash
   docker-compose -f docker-compose.unraid.yml ps
   ```

2. Verify port mapping:
   ```bash
   docker ps | grep phm-web
   ```

3. Check firewall/network:
   ```bash
   curl http://localhost:3000
   ```

### Database Connection Errors

1. Check postgres is healthy:
   ```bash
   docker-compose -f docker-compose.unraid.yml ps postgres
   ```

2. Test database connection:
   ```bash
   docker exec phm-postgres pg_isready -U phm
   ```

3. View database logs:
   ```bash
   docker-compose -f docker-compose.unraid.yml logs postgres
   ```

### Re-initialize Database

**‚ö†Ô∏è WARNING**: This will delete all data!

```bash
docker-compose -f docker-compose.unraid.yml down
rm -rf /mnt/user/appdata/phm/postgres
rm -rf /mnt/user/appdata/phm/init-flag/.db-initialized
docker-compose -f docker-compose.unraid.yml up -d
```

### Reset to Factory Defaults

**‚ö†Ô∏è WARNING**: This will delete ALL data and configuration!

```bash
cd /mnt/user/appdata/phm
docker-compose -f docker-compose.unraid.yml down -v
rm -rf /mnt/user/appdata/phm/postgres
rm -rf /mnt/user/appdata/phm/uploads
rm -rf /mnt/user/appdata/phm/init-flag
rm .env
bash scripts/setup-unraid.sh
```

---

## üîí Security Best Practices

1. **Change Default Password**: Immediately after first login
2. **Use Strong Secrets**: Setup script generates these automatically
3. **Enable HTTPS**: Use Unraid's built-in reverse proxy or Nginx Proxy Manager
4. **Restrict CORS**: Set `CORS_ORIGIN` to your domain, not `*`
5. **Regular Updates**: Run `git pull` and rebuild monthly
6. **Backup Regularly**: Use CA Backup plugin or cron jobs
7. **Firewall Rules**: Only expose necessary ports (3000, 3001)
8. **SSL/TLS**: Use Let's Encrypt certificates via reverse proxy

---

## üìà Performance Tuning

### Database Optimization

Add to `.env`:
```bash
POSTGRES_MAX_CONNECTIONS=100
POSTGRES_SHARED_BUFFERS=256MB
POSTGRES_EFFECTIVE_CACHE_SIZE=1GB
```

Then add to `docker-compose.unraid.yml` under `postgres` service:
```yaml
command:
  - "postgres"
  - "-c"
  - "max_connections=${POSTGRES_MAX_CONNECTIONS:-100}"
  - "-c"
  - "shared_buffers=${POSTGRES_SHARED_BUFFERS:-256MB}"
```

### Container Resources

Limit CPU/memory in `docker-compose.unraid.yml`:

```yaml
services:
  api:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
```

---

## üÜò Support

### Logs Location

All logs available via:
```bash
docker-compose -f docker-compose.unraid.yml logs -f
```

### Common Error Messages

| Error | Solution |
|-------|----------|
| `port already in use` | Change `WEB_PORT` or `API_PORT` in `.env` |
| `database connection refused` | Wait for postgres health check, check logs |
| `permission denied` | Run `chmod -R 755 /mnt/user/appdata/phm` |
| `ENOENT: no such file` | Ensure all directories exist, re-run setup |

### Get Help

1. Check logs: `docker-compose -f docker-compose.unraid.yml logs`
2. Verify health: `docker-compose -f docker-compose.unraid.yml ps`
3. Open GitHub issue with logs and `.env` (remove passwords!)

---

## üìö Additional Resources

- [PHM Documentation](./README.md)
- [Docker Compose Docs](https://docs.docker.com/compose/)
- [Unraid Forums](https://forums.unraid.net/)
- [PostgreSQL on Docker](https://hub.docker.com/_/postgres)

---

## üéâ Success!

You now have a production-ready PHM installation running on Unraid with:

- ‚úÖ Automatic database initialization
- ‚úÖ Secure password generation
- ‚úÖ Health monitoring and auto-restart
- ‚úÖ Persistent data storage
- ‚úÖ One-command updates
- ‚úÖ Complete backup strategy

Happy surveying! üî•
